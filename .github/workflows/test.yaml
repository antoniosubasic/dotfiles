name: Test System Setup ğŸ§ª

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**'
      - 'Dockerfile.*'
      - 'install'
      - 'scripts/**'
      - 'dotfiles/**'
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/**'
      - 'Dockerfile.*'
      - 'install'
      - 'scripts/**'
      - 'dotfiles/**'

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        os: [ubuntu, arch]
    services:
      docker:
        image: docker:latest
        options: --privileged

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“„ Get changes
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          since_last_remote_commit: true

      - name: ğŸ” Check changes
        env:
          changes: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          echo "changes: $changes"
          changes=$(echo $changes | tr ' ' '\n')

          if echo $changes | grep -qE '^(\.github/workflows|Dockerfile|install|scripts)'; then
            args=''
          elif echo $changes | grep -qE '^dotfiles'; then
            args='symlinks'
          else
            echo "ğŸš¨ This should not happen"
            exit 1
          fi

          echo "args: $args"
          echo "args=$args" >> $GITHUB_ENV

      - name: ğŸ³ Build and Run Container
        run: |
          docker build -t ${{ matrix.os }}-test -f Dockerfile.${{ matrix.os }} .
          docker run ${{ matrix.os }}-test /bin/bash -c "./install ${{ env.args }}"

      - name: ğŸ§¹ Cleanup Container
        if: always()
        run: docker container prune -f